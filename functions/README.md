# Firebase Functions - Sistema de Cierre Autom√°tico

## üìã Descripci√≥n General

Este m√≥dulo contiene las Cloud Functions que manejan el sistema de cierre autom√°tico de caja y c√°lculos financieros del negocio. Toda la infraestructura est√° dise√±ada para ser consistente con los stores y composables del frontend.

## üèóÔ∏è Arquitectura e Infraestructura

### Consistencia con Frontend

Las functions siguen los mismos patrones que:

- **useTransaction.js** - Manejo de transacciones
- **transactionStore.js** - Estructura de datos de transacciones
- **useCashClosure.js** - L√≥gica de cierre de caja
- **accountsBalanceStore.js** - C√°lculos financieros y balance

### Principios de Dise√±o

1. **UUIDs Consistentes**: Todas las transacciones usan UUIDs generados con `uuid` v4
2. **Estructura de Datos Uniforme**: Mismos campos y tipos que en el frontend
3. **Trazabilidad**: Metadata completa en todas las operaciones
4. **Logging Detallado**: Logs exhaustivos para debugging y auditor√≠a
5. **Manejo de Errores**: Try-catch con registro en Firestore

## üìÇ Estructura de Archivos

```
functions/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ AccountsBalance/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ onTransactionWrite.js       # Trigger: Actualiza res√∫menes diarios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lazyCloseIfNeeded.js        # Callable: Cierre lazy-open
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scheduledAutoClose.js       # Scheduled: Cierre programado diario
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ testScheduledAutoClose.js   # HTTP: Testing de cierre autom√°tico
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sharedComputed.js           # Helpers: C√°lculos financieros
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sharedStreak.js             # Helpers: Manejo de rachas
‚îÇ   ‚îú‚îÄ‚îÄ Helpers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ time.js                     # Utilidades de fecha/hora con Luxon
‚îÇ   ‚îî‚îÄ‚îÄ index.js                        # Exporta todas las functions
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md                           # Este archivo
```

## üîß Functions Disponibles

### 1. `onTransactionWrite` (Trigger)

**Tipo**: Document Trigger  
**Ruta**: `businesses/{businessId}/transactions/{txId}`  
**Eventos**: create, update, delete

**Descripci√≥n**:
Trigger autom√°tico que se ejecuta cuando cambia cualquier transacci√≥n. Recalcula los agregados del d√≠a y actualiza el resumen diario.

**Flujo**:

1. Detecta cambio en transacci√≥n
2. Obtiene timezone del negocio
3. Calcula d√≠a de la transacci√≥n
4. Obtiene agregados (ingresos, egresos, flags)
5. Actualiza `dailySummaries/{day}`

**Uso**:
Se ejecuta autom√°ticamente. No requiere llamada manual.

---

### 2. `lazyCloseIfNeeded` (Callable)

**Tipo**: Callable Function  
**Endpoint**: `lazyCloseIfNeeded`

**Par√°metros**:

```javascript
{
  businessId: string; // ID del negocio
}
```

**Respuesta**:

```javascript
{
  closed: boolean,        // Si se cre√≥ cierre
  mode?: 'lazyOpen',     // Modo de cierre
  day?: string,          // D√≠a cerrado (yyyy-LL-dd)
  closureId?: string,    // UUID de la transacci√≥n
  reason?: string        // Raz√≥n si no se cerr√≥
}
```

**Descripci√≥n**:
Funci√≥n callable que cierra el d√≠a anterior si qued√≥ abierto sin cierre. Se ejecuta al hacer una apertura nueva (lazy-open).

**Flujo**:

1. Valida autenticaci√≥n y businessId
2. Calcula d√≠a anterior seg√∫n timezone
3. Verifica si tiene apertura sin cierre
4. Crea transacci√≥n de cierre con UUID
5. Actualiza dailySummary
6. Rompe racha de d√≠as consecutivos

**Cu√°ndo se usa**:

- Cuando un usuario inicia una nueva apertura
- El frontend la llama desde `useCashClosure.createOpening()`

**Ejemplo de llamada (Frontend)**:

```javascript
import { getFunctions, httpsCallable } from "firebase/functions";

const functions = getFunctions();
const lazyClose = httpsCallable(functions, "lazyCloseIfNeeded");

const result = await lazyClose({ businessId: "abc123" });
console.log(result.data); // { closed: true, mode: 'lazyOpen', ... }
```

---

### 3. `scheduledAutoClose` (Scheduled)

**Tipo**: Scheduled Function  
**Schedule**: `5 0 * * *` (Diariamente a las 00:05)  
**Timezone**: America/Lima

**Descripci√≥n**:
Funci√≥n programada que se ejecuta autom√°ticamente cada d√≠a a medianoche. Procesa todos los negocios y cierra d√≠as pendientes.

**Flujo**:

1. Se ejecuta autom√°ticamente a las 00:05
2. Obtiene todos los negocios activos
3. Para cada negocio:
   - Calcula d√≠a anterior
   - Obtiene agregados del d√≠a
   - Si est√° abierto sin cierre ‚Üí crea cierre autom√°tico
   - Si est√° completo ‚Üí incrementa racha
4. Guarda resumen de ejecuci√≥n en Firestore

**Casos de uso**:

- **D√≠a abierto sin cierre**: Crea cierre autom√°tico y rompe racha
- **D√≠a completo**: Incrementa racha de d√≠as consecutivos
- **D√≠a sin apertura**: No hace nada

**Configuraci√≥n**:

```javascript
{
  schedule: '5 0 * * *',     // Cron expression
  timeZone: 'America/Lima',  // Timezone
  retryCount: 3,             // Reintentos
  memory: '256MiB',          // Memoria
  timeoutSeconds: 540        // Timeout (9 min)
}
```

**Logs**:
Toda ejecuci√≥n se registra en:

- Cloud Functions logs (Google Cloud Console)
- `scheduled_executions` collection (Firestore)
- `system_logs` collection (errores por negocio)

---

### 4. `testScheduledAutoClose` (HTTP)

**Tipo**: HTTP Request  
**M√©todo**: GET  
**Endpoint**: `https://[region]-[project].cloudfunctions.net/testScheduledAutoClose`

**Query Params**:

```
?businessId=abc123  // Opcional: testear solo un negocio
```

**Respuesta**:

```javascript
{
  success: boolean,
  summary: {
    total: number,           // Total de negocios
    autoClosed: number,      // Cierres creados
    streakIncreased: number, // Rachas incrementadas
    noAction: number         // Sin acci√≥n
  },
  results: [
    {
      businessId: string,
      day: string,
      timezone: string,
      action: 'auto-closed' | 'streak-increased' | 'none',
      transactionId: string | null,
      aggregates: { ... },
      timestamp: string
    }
  ],
  timestamp: string
}
```

**Descripci√≥n**:
Funci√≥n HTTP para testing manual del cierre autom√°tico. Simula el comportamiento de `scheduledAutoClose` con logs detallados.

**Uso**:

```bash
# Testear todos los negocios
curl https://[region]-[project].cloudfunctions.net/testScheduledAutoClose

# Testear un negocio espec√≠fico
curl "https://[region]-[project].cloudfunctions.net/testScheduledAutoClose?businessId=abc123"
```

---

## üõ†Ô∏è Helpers Compartidos

### `sharedComputed.js`

Funciones para c√°lculos financieros (equivalente a `accountsBalanceStore.js`).

#### `getDayAggregates(db, businessId, day, tz)`

Calcula los agregados financieros de un d√≠a espec√≠fico.

**Retorna**:

```javascript
{
  hasOpening: boolean,     // Si existe apertura
  hasClosure: boolean,     // Si existe cierre
  hasTxn: boolean,         // Si hay transacciones operativas
  totals: {
    income: number,        // Total ingresos
    expense: number,       // Total egresos
    net: number           // Resultado neto (income - expense)
  }
}
```

**Tipos de transacciones reconocidas**:

- `opening`: Apertura de caja
- `closure`: Cierre de caja
- `income`: Ingreso (venta)
- `expense`: Egreso (gasto)
- `transfer`: Transferencia entre cuentas

#### `upsertDailySummary(db, businessId, day, patch)`

Inserta o actualiza el resumen diario (merge operation).

**Par√°metros**:

- `db`: Instancia de Firestore
- `businessId`: ID del negocio
- `day`: D√≠a en formato `yyyy-LL-dd`
- `patch`: Objeto con datos a actualizar

**Estructura del documento `dailySummary`**:

```javascript
{
  day: string,              // yyyy-LL-dd
  hasOpening: boolean,
  hasClosure: boolean,
  hasTxn: boolean,
  totals: {
    income: number,
    expense: number,
    net: number
  },
  isAutoClosed: boolean,    // Si fue cierre autom√°tico
  closureId: string,        // UUID de la transacci√≥n de cierre
  autoCloseReason: string,  // 'scheduled' | 'lazyOpen'
  completedAt: Timestamp,
  lastUpdated: Timestamp
}
```

---

### `sharedStreak.js`

Funciones para manejar rachas de d√≠as consecutivos.

#### `breakStreak(db, businessId)`

Rompe la racha de d√≠as consecutivos. Se ejecuta cuando se cierra autom√°ticamente.

**Estructura del documento `streak`**:

```javascript
{
  current: 0,                    // Racha actual reseteada
  max: number,                   // Racha m√°xima (se mantiene)
  lastCompletedDay: string,      // yyyy-LL-dd
  copilotDays: number,          // D√≠as cerrados por copilot
  brokenAt: string              // ISO timestamp
}
```

#### `incStreakIfConsecutive(db, businessId, day, tz)`

Incrementa la racha si el d√≠a es consecutivo al anterior.

**L√≥gica**:

- Si el d√≠a anterior es consecutivo ‚Üí incrementa racha
- Si no es consecutivo ‚Üí reinicia racha a 1
- Siempre actualiza el m√°ximo si se supera

---

### `time.js` (Helpers)

Utilidades de fecha/hora usando Luxon.

**Funciones disponibles**:

```javascript
// Fecha actual en timezone
nowIn(tz = 'America/Lima'): DateTime

// Inicio/fin de d√≠a
startOfDay(dayStr, tz): Date
endOfDay(dayStr, tz): Date

// Strings de fecha
todayStr(tz): string          // yyyy-LL-dd
yesterdayStr(tz): string      // yyyy-LL-dd

// Operaciones
dayMinus(dayStr, n, tz): string
dayFromTimestamp(timestamp, tz): string

// Rangos para queries Firestore
dateRangeForDay(dayStr, tz): { start: Date, end: Date }
```

---

## üîê Estructura de Datos

### Transacci√≥n de Cierre Autom√°tico

```javascript
{
  uuid: string,                // UUID v4 generado con uuid library
  type: 'closure',
  description: string,         // 'Cierre autom√°tico programado' | 'Cierre autom√°tico (lazy-open)'
  source: 'copilot',          // Indica que fue autom√°tico
  copilotMode: string,        // 'scheduled' | 'lazyOpen' | 'test'
  account: 'cash',            // Cuenta por defecto
  amount: 0,                  // Siempre 0 para cierres autom√°ticos
  metadata: {
    day: string,              // yyyy-LL-dd
    triggerType: string,      // Tipo de trigger
    autoGenerated: true,      // Flag de auto-generaci√≥n
    executionTime: string,    // ISO timestamp
    aggregates: {             // Datos del d√≠a
      totalIncome: number,
      totalExpense: number,
      netResult: number,
      hasTransactions: boolean
    }
  },
  createdAt: Timestamp        // serverTimestamp()
}
```

### Resumen Diario (dailySummary)

```javascript
{
  day: '2025-10-13',          // yyyy-LL-dd
  hasOpening: true,
  hasClosure: true,
  hasTxn: true,
  totals: {
    income: 1500.00,
    expense: 500.00,
    net: 1000.00
  },
  isAutoClosed: true,         // Si fue cierre autom√°tico
  closureId: 'uuid-here',     // UUID de la transacci√≥n
  autoCloseReason: 'scheduled',
  completedAt: Timestamp,
  lastUpdated: Timestamp
}
```

### Racha (streak)

```javascript
{
  current: 5,                 // Racha actual
  max: 15,                    // Racha m√°xima hist√≥rica
  lastCompletedDay: '2025-10-13',
  copilotDays: 3,            // D√≠as cerrados por copilot
  brokenAt: '2025-10-14T00:05:00.000Z',  // Opcional
  updatedAt: '2025-10-14T00:05:00.000Z'
}
```

---

## üöÄ Deployment

### Instalar Dependencias

```bash
cd functions
npm install
```

### Deploy Individual

```bash
# Deploy una funci√≥n espec√≠fica
firebase deploy --only functions:onTransactionWrite
firebase deploy --only functions:lazyCloseIfNeeded
firebase deploy --only functions:scheduledAutoClose
firebase deploy --only functions:testScheduledAutoClose
```

### Deploy Todas

```bash
firebase deploy --only functions
```

### Testing Local (Emulators)

```bash
# Iniciar emuladores
firebase emulators:start

# La funci√≥n scheduledAutoClose NO se ejecutar√° autom√°ticamente en emulators
# Usar testScheduledAutoClose para testing manual:
curl "http://localhost:5001/[project-id]/[region]/testScheduledAutoClose"
```

---

## üìä Logs y Monitoreo

### Ver Logs en Tiempo Real

```bash
firebase functions:log --only scheduledAutoClose
```

### Ver en Google Cloud Console

1. Ir a [Google Cloud Console](https://console.cloud.google.com)
2. Seleccionar proyecto
3. Ir a **Cloud Functions** ‚Üí **Logs**
4. Filtrar por nombre de funci√≥n

### Logs en Firestore

**Ejecuciones programadas**:

```javascript
// Collection: scheduled_executions
{
  type: 'auto_close',
  results: { ... },
  duration: 1234,
  timestamp: Timestamp,
  success: true
}
```

**Errores por negocio**:

```javascript
// Collection: system_logs
{
  type: 'scheduled_auto_close_error',
  businessId: 'abc123',
  error: 'Error message',
  stack: 'Stack trace',
  timestamp: Timestamp
}
```

---

## üß™ Testing

### Test Manual con HTTP Function

```bash
# Testear todos los negocios
curl https://us-central1-[project-id].cloudfunctions.net/testScheduledAutoClose

# Testear un negocio espec√≠fico
curl "https://us-central1-[project-id].cloudfunctions.net/testScheduledAutoClose?businessId=abc123"
```

### Test con Firebase CLI

```bash
# Llamar funci√≥n callable
firebase functions:shell
> lazyCloseIfNeeded({businessId: 'abc123'})
```

### Test de Triggers

Los triggers se ejecutan autom√°ticamente al modificar documentos:

```javascript
// En el frontend o Firestore console
await setDoc(doc(db, "businesses/abc123/transactions/xyz"), {
  type: "income",
  amount: 100,
  // ... otros campos
});
// onTransactionWrite se ejecutar√° autom√°ticamente
```

---

## üîß Configuraci√≥n de Cloud Scheduler

Para que `scheduledAutoClose` se ejecute autom√°ticamente en producci√≥n:

1. Ir a [Cloud Scheduler](https://console.cloud.google.com/cloudscheduler)
2. La funci√≥n se auto-registra en el primer deploy
3. Verificar que el schedule est√© configurado: `5 0 * * *`
4. Verificar timezone: `America/Lima`

**Nota**: En emulators, Cloud Scheduler no funciona. Usar `testScheduledAutoClose` para testing.

---

## ‚ö†Ô∏è Consideraciones Importantes

### UUIDs Consistentes

- **Siempre usar `uuid` v4** para generar IDs de transacciones
- NO usar `doc().id` de Firestore (solo para testing)
- Consistente con `useTransaction.js` del frontend

### Timezone

- Siempre pasar timezone del negocio a funciones de tiempo
- Default: `America/Lima` (UTC-5)
- Almacenar en `businesses/{id}.timezone`

### Manejo de Errores

- Siempre usar try-catch en loops de negocios
- No fallar toda la ejecuci√≥n por un negocio
- Registrar errores en `system_logs`

### Performance

- `scheduledAutoClose` tiene timeout de 9 minutos
- Procesa negocios secuencialmente (no paralelo)
- Si hay muchos negocios (>100), considerar batching

### Costos

- Cada ejecuci√≥n programada cuenta como invocaci√≥n
- Triggers cuentan por cada documento modificado
- Ver [Firebase Pricing](https://firebase.google.com/pricing)

---

## üìö Referencias

### Frontend Relacionado

- `src/composables/useTransaction.js` - Creaci√≥n de transacciones
- `src/stores/transaction/transactionStore.js` - Estado de transacciones
- `src/stores/AccountsBalanceApp/accountsBalanceStore.js` - C√°lculos financieros
- `src/composables/useCashClosure.js` - L√≥gica de cierre

### Firebase Docs

- [Cloud Functions v2](https://firebase.google.com/docs/functions)
- [Scheduled Functions](https://firebase.google.com/docs/functions/schedule-functions)
- [Callable Functions](https://firebase.google.com/docs/functions/callable)
- [Firestore Triggers](https://firebase.google.com/docs/functions/firestore-events)

### Librer√≠as

- [uuid](https://www.npmjs.com/package/uuid) - Generaci√≥n de UUIDs
- [Luxon](https://moment.github.io/luxon/) - Manejo de fechas/timezones
- [Firebase Admin](https://firebase.google.com/docs/admin/setup) - SDK de admin

---

## ü§ù Contribuci√≥n

Al agregar nuevas functions:

1. ‚úÖ Seguir la estructura de datos del frontend
2. ‚úÖ Usar UUID v4 para IDs
3. ‚úÖ Agregar logs detallados
4. ‚úÖ Manejar errores apropiadamente
5. ‚úÖ Agregar metadata de trazabilidad
6. ‚úÖ Documentar en este README
7. ‚úÖ Exportar en `index.js`

---

## üìù Changelog

### 2025-10-14

- ‚ú® Migraci√≥n completa a UUID v4 consistente
- üìù Documentaci√≥n exhaustiva de infraestructura
- üîß Mejoras en logs y trazabilidad
- üèóÔ∏è Refactorizaci√≥n para consistencia con frontend
- üêõ Correcciones en manejo de errores
- üìä Agregado de metadata completa en transacciones

---

## üìß Soporte

Para preguntas o issues, contactar al equipo de desarrollo o crear un issue en el repositorio.
