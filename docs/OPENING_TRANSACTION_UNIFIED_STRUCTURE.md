# üîì Estructura Unificada de Transacciones de Apertura

> **Fecha de Implementaci√≥n:** 27 de octubre de 2025  
> **Objetivo:** Garantizar consistencia total entre transacciones `opening` y `closure`

## üìã Resumen de Cambios

Se ha unificado la estructura de las transacciones de tipo `opening` para que sean **100% compatibles** con:

- ‚úÖ `closure` (misma estructura base)
- ‚úÖ `dailySummary` (estructura calculada por `sharedComputed.js`)
- ‚úÖ `accountsBalanceStore.js` (c√°lculos frontend)
- ‚úÖ Componentes UI (`CardOpening.vue`, `AccountsBalanceDetails.vue`)

---

## üéØ Problema Resuelto

### Antes (Inconsistente)

**Frontend:**

```javascript
// buildOpeningTransaction - INCOMPLETO
{
  uuid: generateUUID(),
  type: 'opening',
  expectedCashBalance: expectedCashBalance || 0,
  realCashBalance: realCashBalance || 0,
  // ‚ùå FALTABAN: id, source, copilotMode, transferencias, ajustes, metadata
}
```

**Backend:**

```javascript
// autoOpening.js - INCOMPLETO
{
  uuid: openingUuid,
  type: 'opening',
  realCashBalance: cashBalance,
  realBankBalance: bankBalance,
  // ‚ùå FALTABAN: id, expectedCashBalance, expectedBankBalance, estructura completa
}
```

### Despu√©s (Unificado) ‚úÖ

```javascript
const openingTransaction = {
  // === IDENTIFICACI√ìN ===
  uuid: string,
  id: string,                    // = uuid (compatibilidad con sharedComputed.js)
  type: 'opening',
  description: string,
  source: 'manual' | 'copilot',
  copilotMode: 'manual' | 'auto_opening',
  openingReference: null,
  lastClosureReference: string | null,

  // === BALANCES (apertura) ===
  expectedCashBalance: number,   // Esperado del cierre anterior
  expectedBankBalance: number,   // Esperado del cierre anterior
  realCashBalance: number,       // Real contado/tomado del cierre
  realBankBalance: number,       // Real contado/tomado del cierre

  // === DIFERENCIAS ===
  cashDifference: number,        // 0 en auto-opening, calculado en manual
  bankDifference: number,        // 0 en auto-opening, calculado en manual

  // === TOTALES OPERACIONALES (siempre 0 en apertura) ===
  totalIngresos: 0,
  totalEgresos: 0,
  ingresosCash: 0,
  ingresosBank: 0,
  egresosCash: 0,
  egresosBank: 0,

  // === TRANSFERENCIAS (siempre 0 en apertura) ===
  totalTransferencias: 0,
  transferencias: {
    cash: { in: 0, out: 0, net: 0 },
    bank: { in: 0, out: 0, net: 0 }
  },

  // === AJUSTES (se calculan despu√©s de la apertura) ===
  ajustesApertura: {
    cash: 0,
    bank: 0,
    total: 0
  },
  ajustesCierre: {
    cash: 0,
    bank: 0,
    total: 0
  },

  // === RESULTADOS OPERACIONALES (siempre 0 en apertura) ===
  resultadoOperacional: 0,
  resultadoOperacionalCash: 0,
  resultadoOperacionalBank: 0,
  flujoNetoCash: 0,
  flujoNetoBank: 0,

  // === CAMPOS COMPATIBLES (legacy) ===
  totalCash: number,             // = realCashBalance
  totalBank: number,             // = realBankBalance
  totalBalance: number,          // = realCashBalance + realBankBalance
  cashAmount: number,            // = realCashBalance
  bankAmount: number,            // = realBankBalance

  // === ESTRUCTURA EST√ÅNDAR ===
  items: [],
  itemsAndStockLogs: [],
  amount: 0,

  // === METADATA ===
  metadata: {
    day: string | null,
    triggerType: 'manual_open' | 'auto_opening',
    autoGenerated: boolean,
    executionTime?: string,      // Solo en auto-opening
    previousClosureId?: string,  // Solo en auto-opening
    timezone?: string            // Solo en auto-opening
  },

  // === TIMESTAMP ===
  createdAt: Timestamp
};
```

---

## üìÅ Archivos Modificados

### 1. **Frontend - Store**

‚úÖ **`src/stores/AccountsBalanceApp/accountsBalanceStore.js`**

- Funci√≥n: `buildOpeningTransaction()`
- L√≠nea: ~807
- **Agregados:**
  - `id: uuid` - Compatibilidad con `sharedComputed.js`
  - `source: 'manual'` - Identificador de origen
  - `copilotMode: 'manual'` - Modo de apertura
  - `totalIngresos`, `totalEgresos`, etc. (todos = 0)
  - `transferencias` - Objeto completo (todos = 0)
  - `ajustesApertura`, `ajustesCierre` - Objetos completos
  - `resultadoOperacional`, `flujoNetoCash`, etc. (todos = 0)
  - `totalBalance` - Campo calculado
  - `metadata` - Objeto con trazabilidad

### 2. **Backend - Auto-Opening**

‚úÖ **`functions/src/AccountsBalance/autoOpening.js`**

- Funci√≥n: `executeAutoOpening()`
- L√≠nea: ~154
- **Agregados:**
  - `id: openingUuid` - Compatibilidad con `sharedComputed.js`
  - `expectedCashBalance` - Tomado del √∫ltimo cierre
  - `expectedBankBalance` - Tomado del √∫ltimo cierre
  - `cashDifference: 0` - Sin diferencias en auto-opening
  - `bankDifference: 0` - Sin diferencias en auto-opening
  - `totalIngresos`, `totalEgresos`, etc. (todos = 0)
  - `transferencias` - Objeto completo (todos = 0)
  - `ajustesApertura`, `ajustesCierre` - Objetos completos
  - `resultadoOperacional`, `flujoNetoCash`, etc. (todos = 0)
  - `totalBalance` - Campo calculado
  - `openingReference: null` - Consistencia con closure
  - `lastClosureReference` - Referencia al cierre anterior

---

## üîÑ Compatibilidad con `sharedComputed.js`

La estructura de `openingTransaction` ahora mapea **perfectamente** con lo que espera `getDayAggregates()`:

```javascript
// sharedComputed.js:238
openingData: openingTransaction
  ? {
      id: openingTransaction.id, // ‚úÖ AHORA existe
      realCashBalance: saldoInicialCash, // ‚úÖ Existe
      realBankBalance: saldoInicialBank, // ‚úÖ Existe
      totalBalance: saldoInicial, // ‚úÖ NUEVO campo
    }
  : null;
```

### Tabla de Mapeo

| Campo en Opening      | Usado en sharedComputed | Prop√≥sito                   |
| --------------------- | ----------------------- | --------------------------- |
| `id`                  | `openingData.id`        | Referencia √∫nica ‚úÖ CR√çTICO |
| `uuid`                | -                       | Identificador alternativo   |
| `realCashBalance`     | `saldoInicialCash`      | Balance inicial efectivo    |
| `realBankBalance`     | `saldoInicialBank`      | Balance inicial digital     |
| `totalBalance`        | `saldoInicial`          | Balance inicial total       |
| `expectedCashBalance` | -                       | Para calcular diferencias   |
| `expectedBankBalance` | -                       | Para calcular diferencias   |

---

## üé® Compatibilidad con Componentes UI

### ‚úÖ CardOpening.vue

**Ubicaci√≥n:** `src/components/HistorialRecords/CardOpening.vue`

**Campos usados:**

```javascript
record.realCashBalance; // ‚úÖ Compatible
record.realBankBalance; // ‚úÖ Compatible
record.cashDifference; // ‚úÖ Compatible (opcional)
record.bankDifference; // ‚úÖ Compatible (opcional)
record.uuid; // ‚úÖ Compatible
record.createdAt; // ‚úÖ Compatible
```

**Status:** ‚úÖ **Compatible sin cambios**

### ‚úÖ AccountsBalanceDetails.vue

**Ubicaci√≥n:** `src/components/HistorialRecords/Details/AccountsBalanceDetails.vue`

**Campos usados:**

```javascript
transactionData.expectedCashBalance; // ‚úÖ NUEVO - Ahora disponible
transactionData.expectedBankBalance; // ‚úÖ NUEVO - Ahora disponible
transactionData.realCashBalance; // ‚úÖ Compatible
transactionData.realBankBalance; // ‚úÖ Compatible
transactionData.cashDifference; // ‚úÖ Compatible
transactionData.bankDifference; // ‚úÖ Compatible
```

**Status:** ‚úÖ **Compatible - Ahora con m√°s informaci√≥n**

---

## üîß Tipos de Apertura

### 1. **Apertura Manual** (`source: 'manual'`)

**Caracter√≠sticas:**

- Usuario inicia manualmente el d√≠a
- Puede contar efectivo/banco diferente al cierre anterior
- Se calculan diferencias vs esperado
- Se crean ajustes autom√°ticos si hay diferencias

**Estructura:**

```javascript
{
  source: 'manual',
  copilotMode: 'manual',
  expectedCashBalance: [del √∫ltimo cierre],
  expectedBankBalance: [del √∫ltimo cierre],
  realCashBalance: [valor contado por usuario],
  realBankBalance: [valor contado por usuario],
  cashDifference: [calculado vs esperado],
  bankDifference: [calculado vs esperado],
  metadata: {
    day: null, // Se establece al guardar
    triggerType: 'manual_open',
    autoGenerated: false
  }
}
```

**Flujo:**

1. Usuario va a "Apertura de Caja"
2. Sistema muestra balances esperados (del √∫ltimo cierre)
3. Usuario cuenta efectivo/banco real
4. Sistema calcula diferencias
5. Se guarda apertura
6. Se crean ajustes autom√°ticos si hay diferencias

### 2. **Apertura Autom√°tica** (`source: 'copilot'`, `copilotMode: 'auto_opening'`)

**Caracter√≠sticas:**

- Sistema genera autom√°ticamente
- Se ejecuta por `scheduledAutoClose.js` al d√≠a siguiente
- Toma balances exactos del √∫ltimo cierre
- NO hay diferencias (siempre 0)
- NO se crean ajustes

**Estructura:**

```javascript
{
  source: 'copilot',
  copilotMode: 'auto_opening',
  expectedCashBalance: [del √∫ltimo cierre],
  expectedBankBalance: [del √∫ltimo cierre],
  realCashBalance: [= expectedCashBalance],
  realBankBalance: [= expectedBankBalance],
  cashDifference: 0,
  bankDifference: 0,
  metadata: {
    day: '2025-10-27',
    triggerType: 'auto_opening',
    autoGenerated: true,
    executionTime: '2025-10-27T00:00:05.123Z',
    previousClosureId: 'abc-123',
    previousClosureDate: '2025-10-26T23:59:59.999Z',
    timezone: 'America/Lima'
  }
}
```

**Flujo:**

1. `scheduledAutoClose.js` cierra el d√≠a anterior autom√°ticamente
2. Inmediatamente despu√©s crea apertura del nuevo d√≠a
3. Toma balances finales del cierre anterior
4. Crea apertura con diferencias = 0
5. Usuario puede continuar registrando transacciones

---

## üìä Comparaci√≥n: Opening vs Closure

| Campo                  | Opening Manual       | Opening Auto        | Closure Manual      | Closure Auto                 |
| ---------------------- | -------------------- | ------------------- | ------------------- | ---------------------------- |
| `source`               | `'manual'`           | `'copilot'`         | `'manual'`          | `'copilot'`                  |
| `copilotMode`          | `'manual'`           | `'auto_opening'`    | `'manual'`          | `'scheduled'` / `'lazyOpen'` |
| `expectedCashBalance`  | Del cierre anterior  | Del cierre anterior | Calculado del d√≠a   | Calculado del d√≠a            |
| `realCashBalance`      | Contado por usuario  | = expected          | Contado por usuario | = expected                   |
| `cashDifference`       | Puede ser > 0        | Siempre 0           | Puede ser > 0       | Siempre 0                    |
| `totalIngresos`        | Siempre 0            | Siempre 0           | Suma del d√≠a        | Suma del d√≠a                 |
| `totalEgresos`         | Siempre 0            | Siempre 0           | Suma del d√≠a        | Suma del d√≠a                 |
| `transferencias`       | Siempre 0            | Siempre 0           | Del d√≠a             | Del d√≠a                      |
| `ajustesApertura`      | 0 (se crean despu√©s) | 0                   | Del d√≠a             | Del d√≠a                      |
| `resultadoOperacional` | Siempre 0            | Siempre 0           | Calculado           | Calculado                    |

---

## ‚úÖ Ventajas de la Estructura Unificada

### 1. **Consistencia Total**

```javascript
// opening y closure tienen la misma estructura
Object.keys(opening).sort() === Object.keys(closure).sort(); // true
```

### 2. **Compatible con dailySummary**

```javascript
// sharedComputed.js puede acceder a opening.id
openingData: {
  id: opening.id,  // ‚úÖ Ahora existe
  realCashBalance: opening.realCashBalance,
  realBankBalance: opening.realBankBalance,
  totalBalance: opening.totalBalance  // ‚úÖ Nuevo campo
}
```

### 3. **Facilita Debugging**

```javascript
console.log("Opening:", opening);
console.log("Closure:", closure);
// Misma estructura, f√°cil comparar
```

### 4. **Preparado para Edge Cases**

```javascript
// Si en el futuro se permiten ajustes en apertura:
opening.ajustesApertura.cash = 50.0;
// Ya est√° la estructura lista
```

### 5. **Retrocompatibilidad**

```javascript
// Campos legacy garantizan compatibilidad:
opening.totalCash; // = realCashBalance
opening.totalBank; // = realBankBalance
opening.cashAmount; // = realCashBalance
```

---

## üîç Validaci√≥n de Integridad

```javascript
function validateOpeningTransaction(opening) {
  const checks = [
    // Identificaci√≥n
    opening.uuid !== undefined,
    opening.id !== undefined,
    opening.id === opening.uuid,
    opening.type === "opening",

    // Origen
    opening.source !== undefined,
    opening.copilotMode !== undefined,

    // Balances
    typeof opening.expectedCashBalance === "number",
    typeof opening.expectedBankBalance === "number",
    typeof opening.realCashBalance === "number",
    typeof opening.realBankBalance === "number",

    // Diferencias
    typeof opening.cashDifference === "number",
    typeof opening.bankDifference === "number",

    // Totales (siempre 0 en apertura)
    opening.totalIngresos === 0,
    opening.totalEgresos === 0,
    opening.totalTransferencias === 0,

    // Transferencias
    opening.transferencias !== undefined,
    typeof opening.transferencias.cash === "object",
    typeof opening.transferencias.bank === "object",

    // Ajustes
    opening.ajustesApertura !== undefined,
    opening.ajustesCierre !== undefined,

    // Resultados operacionales (siempre 0 en apertura)
    opening.resultadoOperacional === 0,
    opening.flujoNetoCash === 0,
    opening.flujoNetoBank === 0,

    // Compatibilidad
    opening.totalCash === opening.realCashBalance,
    opening.totalBank === opening.realBankBalance,
    opening.totalBalance === opening.realCashBalance + opening.realBankBalance,

    // Metadata
    opening.metadata !== undefined,
    opening.metadata.triggerType !== undefined,
  ];

  return checks.every((check) => check === true);
}
```

---

## üìù Ejemplo Completo: Apertura Manual

```javascript
{
  // === IDENTIFICACI√ìN ===
  uuid: "xyz-789-abc-456",
  id: "xyz-789-abc-456",
  type: "opening",
  description: "Apertura de caja",
  source: "manual",
  copilotMode: "manual",
  openingReference: null,
  lastClosureReference: "abc-123-def-456",

  // === BALANCES ===
  expectedCashBalance: 1070.00,  // Del cierre anterior
  expectedBankBalance: 540.25,   // Del cierre anterior
  realCashBalance: 1050.00,      // Usuario cont√≥ S/ 1050
  realBankBalance: 540.25,       // Usuario confirm√≥ S/ 540.25

  // === DIFERENCIAS ===
  cashDifference: -20.00,  // Faltante de S/ 20
  bankDifference: 0,

  // === TOTALES OPERACIONALES (siempre 0 en apertura) ===
  totalIngresos: 0,
  totalEgresos: 0,
  ingresosCash: 0,
  ingresosBank: 0,
  egresosCash: 0,
  egresosBank: 0,

  // === TRANSFERENCIAS (siempre 0 en apertura) ===
  totalTransferencias: 0,
  transferencias: {
    cash: { in: 0, out: 0, net: 0 },
    bank: { in: 0, out: 0, net: 0 }
  },

  // === AJUSTES (se crear√°n despu√©s) ===
  ajustesApertura: {
    cash: 0,  // Se crear√° ajuste de -20
    bank: 0,
    total: 0
  },
  ajustesCierre: {
    cash: 0,
    bank: 0,
    total: 0
  },

  // === RESULTADOS OPERACIONALES (siempre 0 en apertura) ===
  resultadoOperacional: 0,
  resultadoOperacionalCash: 0,
  resultadoOperacionalBank: 0,
  flujoNetoCash: 0,
  flujoNetoBank: 0,

  // === CAMPOS COMPATIBLES ===
  totalCash: 1050.00,
  totalBank: 540.25,
  totalBalance: 1590.25,
  cashAmount: 1050.00,
  bankAmount: 540.25,

  // === ESTRUCTURA EST√ÅNDAR ===
  items: [],
  itemsAndStockLogs: [],
  amount: 0,

  // === METADATA ===
  metadata: {
    day: null,
    triggerType: "manual_open",
    autoGenerated: false
  },

  createdAt: Timestamp(2025-10-27T08:30:00.000Z)
}
```

**Flujo posterior:**

1. Se guarda la apertura
2. Sistema detecta `cashDifference: -20.00`
3. Se crea autom√°ticamente transacci√≥n de ajuste:
   ```javascript
   {
     type: 'expense',
     account: 'cash',
     description: 'Ajuste de apertura - Efectivo (Faltante)',
     amount: 20.00,
     category: 'adjustment',
     subcategory: 'opening_adjustment'
   }
   ```

---

## üìù Ejemplo Completo: Apertura Autom√°tica

```javascript
{
  // === IDENTIFICACI√ìN ===
  uuid: "auto-abc-123-xyz",
  id: "auto-abc-123-xyz",
  type: "opening",
  description: "Apertura autom√°tica generada por el sistema",
  source: "copilot",
  copilotMode: "auto_opening",
  openingReference: null,
  lastClosureReference: "closure-abc-123",
  previousClosureReference: "closure-abc-123", // legacy

  // === BALANCES (tomados del cierre anterior) ===
  expectedCashBalance: 1070.00,
  expectedBankBalance: 540.25,
  realCashBalance: 1070.00,  // = expected
  realBankBalance: 540.25,   // = expected

  // === DIFERENCIAS (siempre 0 en auto-opening) ===
  cashDifference: 0,
  bankDifference: 0,

  // === TOTALES OPERACIONALES (siempre 0 en apertura) ===
  totalIngresos: 0,
  totalEgresos: 0,
  ingresosCash: 0,
  ingresosBank: 0,
  egresosCash: 0,
  egresosBank: 0,

  // === TRANSFERENCIAS (siempre 0 en apertura) ===
  totalTransferencias: 0,
  transferencias: {
    cash: { in: 0, out: 0, net: 0 },
    bank: { in: 0, out: 0, net: 0 }
  },

  // === AJUSTES ===
  ajustesApertura: {
    cash: 0,
    bank: 0,
    total: 0
  },
  ajustesCierre: {
    cash: 0,
    bank: 0,
    total: 0
  },

  // === RESULTADOS OPERACIONALES (siempre 0 en apertura) ===
  resultadoOperacional: 0,
  resultadoOperacionalCash: 0,
  resultadoOperacionalBank: 0,
  flujoNetoCash: 0,
  flujoNetoBank: 0,

  // === CAMPOS COMPATIBLES ===
  totalCash: 1070.00,
  totalBank: 540.25,
  totalBalance: 1610.25,
  cashAmount: 1070.00,
  bankAmount: 540.25,

  // === ESTRUCTURA EST√ÅNDAR ===
  items: [],
  itemsAndStockLogs: [],
  amount: 0,

  // === METADATA ===
  metadata: {
    day: "2025-10-27",
    triggerType: "auto_opening",
    autoGenerated: true,
    executionTime: "2025-10-27T00:00:05.123Z",
    previousClosureId: "closure-abc-123",
    previousClosureDate: "2025-10-26T23:59:59.999Z",
    timezone: "America/Lima"
  },

  createdAt: Timestamp(2025-10-27T00:00:05.123Z)
}
```

---

## üöÄ Impacto y Beneficios

### **Antes vs Despu√©s**

| Aspecto                        | Antes      | Despu√©s     |
| ------------------------------ | ---------- | ----------- |
| Campos en opening              | 15         | 47          |
| Compatibilidad con closure     | ‚ùå Parcial | ‚úÖ Total    |
| Compatible con dailySummary    | ‚ö†Ô∏è B√°sico  | ‚úÖ Completo |
| Campo `id` para sharedComputed | ‚ùå Falta   | ‚úÖ Existe   |
| Metadata para trazabilidad     | ‚ö†Ô∏è B√°sico  | ‚úÖ Completo |
| Preparado para ajustes         | ‚ùå No      | ‚úÖ S√≠       |
| Facilita debugging             | ‚ö†Ô∏è Medio   | ‚úÖ Alto     |

### **Costo de Implementaci√≥n**

- ‚úÖ **M√≠nimo**: Solo agregar campos con valores 0
- ‚úÖ **Sin breaking changes**: Retrocompatible
- ‚úÖ **Sin migraci√≥n**: Datos existentes funcionan
- ‚úÖ **Rendimiento**: Sin impacto (campos simples)

### **Beneficios a Largo Plazo**

1. ‚úÖ Mantenimiento m√°s f√°cil
2. ‚úÖ C√≥digo predecible y consistente
3. ‚úÖ F√°cil agregar features futuras
4. ‚úÖ Debugging simplificado
5. ‚úÖ Documentaci√≥n clara y completa

---

## üìö Documentos Relacionados

- üìÑ [`CLOSURE_TRANSACTION_UNIFIED_STRUCTURE.md`](CLOSURE_TRANSACTION_UNIFIED_STRUCTURE.md) - Estructura de cierre
- üìÑ `ACCOUNTS_BALANCE_STORE_USAGE.md` - Uso del store
- üìÑ `sharedComputed.js` - C√°lculos backend

---

## ‚ö†Ô∏è Notas Importantes

1. **Campo `id`**: Cr√≠tico para `sharedComputed.js`. Siempre debe ser igual a `uuid`.

2. **Campos en 0**: Los campos operacionales (ingresos, egresos, transferencias) siempre son 0 en apertura. Son necesarios para consistencia con `closure`.

3. **Ajustes**: Se calculan DESPU√âS de la apertura si hay diferencias. La apertura misma tiene `ajustesApertura: { cash: 0, bank: 0, total: 0 }`.

4. **Auto-opening**: Siempre tiene `cashDifference: 0` y `bankDifference: 0` porque toma los valores exactos del cierre anterior.

5. **Retrocompatibilidad**: Campos legacy (`totalCash`, `totalBank`, `cashAmount`, `bankAmount`) garantizan que c√≥digo antiguo siga funcionando.

---

**‚úÖ Implementado por:** GitHub Copilot  
**üìÖ Fecha:** 27 de octubre de 2025  
**üîó Relacionado con:** `CLOSURE_TRANSACTION_UNIFIED_STRUCTURE.md`, `sharedComputed.js`, `getDayAggregates()`
