# üîí Estructura Unificada de Transacciones de Cierre

> **Fecha de Implementaci√≥n:** 27 de octubre de 2025  
> **Objetivo:** Garantizar consistencia total entre frontend y backend en las transacciones tipo `closure`

## üìã Resumen de Cambios

Se ha unificado la estructura de las transacciones de tipo `closure` para que sean **100% compatibles** con:

- ‚úÖ `dailySummary` (estructura calculada por `sharedComputed.js`)
- ‚úÖ `accountsBalanceStore.js` (c√°lculos frontend)
- ‚úÖ Componentes UI (`CardClosure.vue`, `AccountsBalanceDetails.vue`)

## üéØ Problema Resuelto

### Antes (Inconsistente)

```javascript
// Backend: scheduledAutoClose.js
const closureTransaction = {
  uuid: closureUuid,
  type: "closure",
  // ... solo campos b√°sicos
  totalIngresos: totals.income || 0,
  totalEgresos: totals.expense || 0,
  // ‚ùå FALTABAN: transferencias, ajustes, resultados operacionales
};

// Frontend: accountsBalanceStore.js
const closureTransaction = {
  uuid: generateUUID(),
  type: "closure",
  // ... estructura diferente
  // ‚ùå FALTABAN: source, copilotMode, transferencias detalladas
};
```

### Despu√©s (Unificado) ‚úÖ

```javascript
const closureTransaction = {
  // === IDENTIFICACI√ìN ===
  uuid: string,
  type: "closure",
  description: string,
  source: "copilot" | "manual",
  copilotMode: "scheduled" | "lazyOpen" | "manual",
  openingReference: string | null,

  // === SALDOS INICIALES (de apertura) ===
  initialCashBalance: number,
  initialBankBalance: number,

  // === TOTALES GENERALES (sin ajustes) ===
  totalIngresos: number,
  totalEgresos: number,
  ingresosCash: number,
  ingresosBank: number,
  egresosCash: number,
  egresosBank: number,

  // === TRANSFERENCIAS ===
  totalTransferencias: number,
  transferencias: {
    cash: { in: number, out: number, net: number },
    bank: { in: number, out: number, net: number },
  },

  // === AJUSTES ===
  ajustesApertura: {
    cash: number,
    bank: number,
    total: number,
  },
  ajustesCierre: {
    cash: number,
    bank: number,
    total: number,
  },

  // === BALANCES ESPERADOS (sin ajustes cierre) ===
  expectedCashBalance: number,
  expectedBankBalance: number,

  // === BALANCES REALES ===
  realCashBalance: number,
  realBankBalance: number,

  // === DIFERENCIAS ===
  cashDifference: number,
  bankDifference: number,

  // === RESULTADOS OPERACIONALES ===
  resultadoOperacional: number,
  resultadoOperacionalCash: number,
  resultadoOperacionalBank: number,
  flujoNetoCash: number,
  flujoNetoBank: number,

  // === CAMPOS COMPATIBLES (legacy) ===
  totalCash: number, // = realCashBalance
  totalBank: number, // = realBankBalance
  cashAmount: number, // = realCashBalance
  bankAmount: number, // = realBankBalance

  // === ESTRUCTURA EST√ÅNDAR ===
  items: [],
  itemsAndStockLogs: [],
  amount: 0,

  // === METADATA ===
  metadata: {
    day: string,
    triggerType: string,
    autoGenerated: boolean,
    executionTime: string,
    hasTransactions: boolean,
  },

  // === TIMESTAMP ===
  createdAt: Timestamp,
};
```

## üìÅ Archivos Modificados

### 1. **Frontend**

- ‚úÖ `src/stores/AccountsBalanceApp/accountsBalanceStore.js`
  - Funci√≥n: `buildClosureTransaction()`
  - Agregados: `source`, `copilotMode`, `transferencias`, `ajustesApertura`, `ajustesCierre`, `resultadoOperacional`, etc.

### 2. **Backend - Cierre Programado**

- ‚úÖ `functions/src/AccountsBalance/scheduledAutoClose.js`
  - L√≠nea ~187: `closureTransaction`
  - Agregados: Estructura completa con transferencias, ajustes y resultados operacionales
  - Acceso correcto a: `summary.transfers`, `summary.adjustments`, `summary.operational`

### 3. **Backend - Cierre Lazy (Apertura Tard√≠a)**

- ‚úÖ `functions/src/AccountsBalance/lazyCloseIfNeeded.js`
  - L√≠nea ~105: `closureTransaction`
  - Correcci√≥n: Acceso a `agg.openingData` (antes `agg.opening`)
  - Correcci√≥n: Acceso a `agg.byAccount`, `agg.balances`, `agg.totals` (estructura correcta de `getDayAggregates`)
  - Agregados: Estructura completa compatible con `dailySummary`

## üîÑ Compatibilidad con `getDayAggregates` (sharedComputed.js)

La estructura de `closureTransaction` ahora mapea **perfectamente** con la salida de `getDayAggregates()`:

| Campo en Closure          | Origen en getDayAggregates  | Tipo   |
| ------------------------- | --------------------------- | ------ |
| `totalIngresos`           | `totals.income`             | number |
| `totalEgresos`            | `totals.expense`            | number |
| `ingresosCash`            | `byAccount.cash.income`     | number |
| `ingresosBank`            | `byAccount.bank.income`     | number |
| `transferencias.cash.net` | `transfers.cash.net`        | number |
| `ajustesApertura.total`   | `adjustments.opening.total` | number |
| `ajustesCierre.total`     | `adjustments.closure.total` | number |
| `resultadoOperacional`    | `operational.result`        | number |
| `flujoNetoCash`           | `operational.flowCash`      | number |
| `expectedCashBalance`     | `balances.expected.cash`    | number |
| `realCashBalance`         | `balances.actual.cash`      | number |

## üé® Compatibilidad con Componentes UI

### ‚úÖ CardClosure.vue

Usa correctamente:

- `record.realCashBalance`
- `record.realBankBalance`
- `record.createdAt`

**Status:** ‚úÖ Compatible sin cambios

### ‚úÖ AccountsBalanceDetails.vue

Usa correctamente:

- `transactionData.initialCashBalance`
- `transactionData.initialBankBalance`
- `transactionData.totalIngresos` (calculado desde `ingresosCash` + `ingresosBank`)
- `transactionData.totalEgresos` (calculado desde `egresosCash` + `egresosBank`)
- `transactionData.expectedCashBalance`
- `transactionData.expectedBankBalance`
- `transactionData.realCashBalance`
- `transactionData.realBankBalance`
- `transactionData.cashDifference`
- `transactionData.bankDifference`

**Status:** ‚úÖ Compatible sin cambios

## üîß Tipos de Cierre y sus Campos Especiales

### 1. **Cierre Manual** (`source: 'manual'`)

```javascript
{
  source: 'manual',
  copilotMode: 'manual',
  // Usuario cuenta efectivo/banco real
  realCashBalance: [valor contado],
  realBankBalance: [valor contado],
  cashDifference: [calculado vs esperado],
  bankDifference: [calculado vs esperado],
  // Puede haber ajustes de cierre si hay diferencias
  ajustesCierre: { cash: X, bank: Y, total: Z }
}
```

### 2. **Cierre Autom√°tico Programado** (`source: 'copilot'`, `copilotMode: 'scheduled'`)

```javascript
{
  source: 'copilot',
  copilotMode: 'scheduled',
  // Balance real = esperado (sin conteo f√≠sico)
  realCashBalance: expectedCashBalance,
  realBankBalance: expectedBankBalance,
  cashDifference: 0,
  bankDifference: 0,
  // NO hay ajustes de cierre
  ajustesCierre: { cash: 0, bank: 0, total: 0 },
  metadata: {
    triggerType: 'scheduled_auto_close',
    autoGenerated: true,
    hasTransactions: boolean
  }
}
```

### 3. **Cierre Lazy (Apertura Tard√≠a)** (`source: 'copilot'`, `copilotMode: 'lazyOpen'`)

```javascript
{
  source: 'copilot',
  copilotMode: 'lazyOpen',
  // Balance real = esperado (sin conteo f√≠sico)
  realCashBalance: balances.actual.cash,
  realBankBalance: balances.actual.bank,
  cashDifference: 0,
  bankDifference: 0,
  // NO hay ajustes de cierre
  ajustesCierre: { cash: 0, bank: 0, total: 0 },
  metadata: {
    closedDay: day,           // D√≠a que se cerr√≥ (d√≠a anterior)
    triggerType: 'lazy_open',
    autoGenerated: true,
    actualExecutionTime: ISO8601,  // Cu√°ndo se ejecut√≥ realmente
    closureTimestamp: ISO8601      // Timestamp l√≥gico del cierre
  },
  // createdAt es el final del d√≠a anterior (23:59:59.999)
  createdAt: closureTimestamp
}
```

## üéØ Ventajas de la Estructura Unificada

1. **‚úÖ Compatibilidad Total con dailySummary**

   - Todos los campos coinciden 1:1
   - F√°cil inserci√≥n/actualizaci√≥n

2. **‚úÖ Componentes UI Funcionan Sin Cambios**

   - `CardClosure.vue` renderiza correctamente
   - `AccountsBalanceDetails.vue` muestra toda la informaci√≥n

3. **‚úÖ Consistencia Backend-Frontend**

   - Misma estructura en todos los puntos
   - F√°cil debugging y mantenimiento

4. **‚úÖ Trazabilidad Completa**

   - Campos `source` y `copilotMode` identifican origen
   - Metadata detallada para auditor√≠a

5. **‚úÖ Extensibilidad**
   - F√°cil agregar nuevos campos sin romper compatibilidad
   - Campos legacy garantizan retrocompatibilidad

## üìä Ejemplo Completo

### Cierre Autom√°tico Programado (D√≠a con Actividad)

```javascript
{
  uuid: "abc-123-def-456",
  type: "closure",
  description: "Cierre autom√°tico programado",
  source: "copilot",
  copilotMode: "scheduled",
  openingReference: "xyz-789",

  initialCashBalance: 500.00,
  initialBankBalance: 300.00,

  totalIngresos: 1200.50,
  totalEgresos: 450.25,
  ingresosCash: 800.00,
  ingresosBank: 400.50,
  egresosCash: 250.00,
  egresosBank: 200.25,

  totalTransferencias: 100.00,
  transferencias: {
    cash: { in: 50.00, out: 100.00, net: -50.00 },
    bank: { in: 100.00, out: 50.00, net: 50.00 }
  },

  ajustesApertura: {
    cash: 20.00,
    bank: -10.00,
    total: 10.00
  },
  ajustesCierre: {
    cash: 0,
    bank: 0,
    total: 0
  },

  expectedCashBalance: 1070.00,
  expectedBankBalance: 540.25,
  realCashBalance: 1070.00,
  realBankBalance: 540.25,

  cashDifference: 0,
  bankDifference: 0,

  resultadoOperacional: 750.25,
  resultadoOperacionalCash: 550.00,
  resultadoOperacionalBank: 200.25,
  flujoNetoCash: 500.00,
  flujoNetoBank: 250.25,

  totalCash: 1070.00,
  totalBank: 540.25,
  cashAmount: 1070.00,
  bankAmount: 540.25,

  items: [],
  itemsAndStockLogs: [],
  amount: 0,

  metadata: {
    day: "2025-10-26",
    triggerType: "scheduled_auto_close",
    autoGenerated: true,
    executionTime: "2025-10-27T00:00:05.123Z",
    hasTransactions: true
  },

  createdAt: Timestamp(2025-10-27T00:00:05.123Z)
}
```

## üîç Validaci√≥n de Integridad

Para verificar que una transacci√≥n de cierre es v√°lida:

```javascript
function validateClosureTransaction(closure) {
  const checks = [
    // Campos requeridos
    closure.uuid !== undefined,
    closure.type === "closure",
    closure.source !== undefined,
    closure.copilotMode !== undefined,

    // Balances
    typeof closure.initialCashBalance === "number",
    typeof closure.realCashBalance === "number",
    typeof closure.expectedCashBalance === "number",

    // Totales
    typeof closure.totalIngresos === "number",
    typeof closure.totalEgresos === "number",

    // Transferencias
    closure.transferencias !== undefined,
    typeof closure.transferencias.cash === "object",
    typeof closure.transferencias.bank === "object",

    // Ajustes
    closure.ajustesApertura !== undefined,
    closure.ajustesCierre !== undefined,

    // Resultados operacionales
    typeof closure.resultadoOperacional === "number",
    typeof closure.flujoNetoCash === "number",

    // Metadata
    closure.metadata !== undefined,
    closure.metadata.triggerType !== undefined,
  ];

  return checks.every((check) => check === true);
}
```

## üöÄ Siguientes Pasos

1. **‚úÖ Implementaci√≥n completada** - Estructura unificada en todos los archivos
2. **‚è≥ Testing** - Probar cierres manuales, programados y lazy en desarrollo
3. **‚è≥ Migraci√≥n** - Actualizar transacciones de cierre existentes si es necesario
4. **‚è≥ Documentaci√≥n adicional** - Agregar ejemplos en componentes UI

## üìù Notas Importantes

- **Retrocompatibilidad:** Los campos legacy (`totalCash`, `totalBank`, `cashAmount`, `bankAmount`) garantizan que c√≥digo antiguo siga funcionando
- **Campos opcionales seguros:** Uso de optional chaining (`?.`) en backend para acceso seguro
- **Timestamp correcto en lazy-close:** `createdAt` se establece al final del d√≠a anterior (23:59:59.999)
- **Zero-adjustment en auto-close:** Los cierres autom√°ticos siempre tienen `cashDifference: 0` y `bankDifference: 0`

---

**‚úÖ Implementado por:** GitHub Copilot  
**üìÖ Fecha:** 27 de octubre de 2025  
**üîó Relacionado con:** `ACCOUNTS_BALANCE_STORE_USAGE.md`, `sharedComputed.js`, `getDayAggregates()`
