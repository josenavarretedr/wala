# ğŸ”’ Estructura Unificada de Transacciones de Cierre

> **Fecha de ImplementaciÃ³n:** 27 de octubre de 2025  
> **Objetivo:** Garantizar consistencia total entre frontend y backend en las transacciones tipo `closure`

## ğŸ“‹ Resumen de Cambios

Se ha unificado la estructura de las transacciones de tipo `closure` para que sean **100% compatibles** con:

- âœ… `dailySummary` (estructura calculada por `sharedComputed.js`)
- âœ… `accountsBalanceStore.js` (cÃ¡lculos frontend)
- âœ… Componentes UI (`CardClosure.vue`, `AccountsBalanceDetails.vue`)

## ğŸ¯ Problema Resuelto

### Antes (Inconsistente)

```javascript
// Backend: scheduledAutoClose.js
const closureTransaction = {
  uuid: closureUuid,
  type: "closure",
  // ... solo campos bÃ¡sicos
  totalIngresos: totals.income || 0,
  totalEgresos: totals.expense || 0,
  // âŒ FALTABAN: transferencias, ajustes, resultados operacionales
};

// Frontend: accountsBalanceStore.js
const closureTransaction = {
  uuid: generateUUID(),
  type: "closure",
  // ... estructura diferente
  // âŒ FALTABAN: source, copilotMode, transferencias detalladas
};
```

### DespuÃ©s (Unificado) âœ…

```javascript
const closureTransaction = {
  // === IDENTIFICACIÃ“N ===
  uuid: string,
  type: "closure",
  description: string,
  source: "copilot" | "manual",
  copilotMode: "scheduled" | "lazyOpen" | "manual",
  openingReference: string | null,

  // === SALDOS INICIALES (de apertura) ===
  initialCashBalance: number,
  initialBankBalance: number,

  // === TOTALES GENERALES (sin ajustes) ===
  totalIngresos: number,
  totalEgresos: number,
  ingresosCash: number,
  ingresosBank: number,
  egresosCash: number,
  egresosBank: number,

  // === TRANSFERENCIAS ===
  totalTransferencias: number,
  transferencias: {
    cash: { in: number, out: number, net: number },
    bank: { in: number, out: number, net: number },
  },

  // === AJUSTES ===
  ajustesApertura: {
    cash: number,
    bank: number,
    total: number,
  },
  ajustesCierre: {
    cash: number,
    bank: number,
    total: number,
  },

  // === BALANCES ESPERADOS (sin ajustes cierre) ===
  expectedCashBalance: number,
  expectedBankBalance: number,

  // === BALANCES REALES ===
  realCashBalance: number,
  realBankBalance: number,

  // === DIFERENCIAS ===
  cashDifference: number,
  bankDifference: number,

  // === RESULTADOS OPERACIONALES ===
  resultadoOperacional: number,
  resultadoOperacionalCash: number,
  resultadoOperacionalBank: number,
  flujoNetoCash: number,
  flujoNetoBank: number,

  // === CAMPOS COMPATIBLES (legacy) ===
  totalCash: number, // = realCashBalance
  totalBank: number, // = realBankBalance
  cashAmount: number, // = realCashBalance
  bankAmount: number, // = realBankBalance

  // === ESTRUCTURA ESTÃNDAR ===
  items: [],
  itemsAndStockLogs: [],
  amount: 0,

  // === METADATA ===
  metadata: {
    day: string,
    triggerType: string,
    autoGenerated: boolean,
    executionTime: string,
    hasTransactions: boolean,
  },

  // === TIMESTAMP ===
  createdAt: Timestamp,
};
```

## ğŸ“ Archivos Modificados

### 1. **Frontend**

- âœ… `src/stores/AccountsBalanceApp/accountsBalanceStore.js`
  - FunciÃ³n: `buildClosureTransaction()`
  - Agregados: `source`, `copilotMode`, `transferencias`, `ajustesApertura`, `ajustesCierre`, `resultadoOperacional`, etc.

### 2. **Backend - Cierre Programado**

- âœ… `functions/src/AccountsBalance/scheduledAutoClose.js`
  - LÃ­nea ~187: `closureTransaction`
  - Agregados: Estructura completa con transferencias, ajustes y resultados operacionales
  - Acceso correcto a: `summary.transfers`, `summary.adjustments`, `summary.operational`

### 3. **Backend - Cierre Lazy (Apertura TardÃ­a)**

- âœ… `functions/src/AccountsBalance/lazyCloseIfNeeded.js`
  - LÃ­nea ~105: `closureTransaction`
  - CorrecciÃ³n: Acceso a `agg.openingData` (antes `agg.opening`)
  - CorrecciÃ³n: Acceso a `agg.byAccount`, `agg.balances`, `agg.totals` (estructura correcta de `getDayAggregates`)
  - Agregados: Estructura completa compatible con `dailySummary`

## ğŸ”„ Compatibilidad con `getDayAggregates` (sharedComputed.js)

La estructura de `closureTransaction` ahora mapea **perfectamente** con la salida de `getDayAggregates()`:

| Campo en Closure          | Origen en getDayAggregates  | Tipo   |
| ------------------------- | --------------------------- | ------ |
| `totalIngresos`           | `totals.income`             | number |
| `totalEgresos`            | `totals.expense`            | number |
| `ingresosCash`            | `byAccount.cash.income`     | number |
| `ingresosBank`            | `byAccount.bank.income`     | number |
| `transferencias.cash.net` | `transfers.cash.net`        | number |
| `ajustesApertura.total`   | `adjustments.opening.total` | number |
| `ajustesCierre.total`     | `adjustments.closure.total` | number |
| `resultadoOperacional`    | `operational.result`        | number |
| `flujoNetoCash`           | `operational.flowCash`      | number |
| `expectedCashBalance`     | `balances.expected.cash`    | number |
| `realCashBalance`         | `balances.actual.cash`      | number |

## ğŸ¨ Compatibilidad con Componentes UI

### âœ… CardClosure.vue

Usa correctamente:

- `record.realCashBalance`
- `record.realBankBalance`
- `record.createdAt`

**Status:** âœ… Compatible sin cambios

### âœ… AccountsBalanceDetails.vue

Usa correctamente:

- `transactionData.initialCashBalance`
- `transactionData.initialBankBalance`
- `transactionData.totalIngresos` (calculado desde `ingresosCash` + `ingresosBank`)
- `transactionData.totalEgresos` (calculado desde `egresosCash` + `egresosBank`)
- `transactionData.expectedCashBalance`
- `transactionData.expectedBankBalance`
- `transactionData.realCashBalance`
- `transactionData.realBankBalance`
- `transactionData.cashDifference`
- `transactionData.bankDifference`

**Status:** âœ… Compatible sin cambios

## ğŸ”§ Tipos de Cierre y sus Campos Especiales

### 1. **Cierre Manual** (`source: 'manual'`)

```javascript
{
  source: 'manual',
  copilotMode: 'manual',
  // Usuario cuenta efectivo/banco real
  realCashBalance: [valor contado],
  realBankBalance: [valor contado],
  cashDifference: [calculado vs esperado],
  bankDifference: [calculado vs esperado],
  // Puede haber ajustes de cierre si hay diferencias
  ajustesCierre: { cash: X, bank: Y, total: Z }
}
```

### 2. **Cierre AutomÃ¡tico Programado** (`source: 'copilot'`, `copilotMode: 'scheduled'`)

```javascript
{
  source: 'copilot',
  copilotMode: 'scheduled',
  // Balance real = esperado (sin conteo fÃ­sico)
  realCashBalance: expectedCashBalance,
  realBankBalance: expectedBankBalance,
  cashDifference: 0,
  bankDifference: 0,
  // NO hay ajustes de cierre
  ajustesCierre: { cash: 0, bank: 0, total: 0 },
  metadata: {
    triggerType: 'scheduled_auto_close',
    autoGenerated: true,
    hasTransactions: boolean
  }
}
```

### 3. **Cierre Lazy (Apertura TardÃ­a)** (`source: 'copilot'`, `copilotMode: 'lazyOpen'`)

```javascript
{
  source: 'copilot',
  copilotMode: 'lazyOpen',
  // Balance real = esperado (sin conteo fÃ­sico)
  realCashBalance: balances.actual.cash,
  realBankBalance: balances.actual.bank,
  cashDifference: 0,
  bankDifference: 0,
  // NO hay ajustes de cierre
  ajustesCierre: { cash: 0, bank: 0, total: 0 },
  metadata: {
    closedDay: day,           // DÃ­a que se cerrÃ³ (dÃ­a anterior)
    triggerType: 'lazy_open',
    autoGenerated: true,
    actualExecutionTime: ISO8601,  // CuÃ¡ndo se ejecutÃ³ realmente
    closureTimestamp: ISO8601      // Timestamp lÃ³gico del cierre
  },
  // createdAt es el final del dÃ­a anterior (23:59:59.999)
  createdAt: closureTimestamp
}
```

## ğŸ¯ Ventajas de la Estructura Unificada

1. **âœ… Compatibilidad Total con dailySummary**

   - Todos los campos coinciden 1:1
   - FÃ¡cil inserciÃ³n/actualizaciÃ³n

2. **âœ… Componentes UI Funcionan Sin Cambios**

   - `CardClosure.vue` renderiza correctamente
   - `AccountsBalanceDetails.vue` muestra toda la informaciÃ³n

3. **âœ… Consistencia Backend-Frontend**

   - Misma estructura en todos los puntos
   - FÃ¡cil debugging y mantenimiento

4. **âœ… Trazabilidad Completa**

   - Campos `source` y `copilotMode` identifican origen
   - Metadata detallada para auditorÃ­a

5. **âœ… Extensibilidad**
   - FÃ¡cil agregar nuevos campos sin romper compatibilidad
   - Campos legacy garantizan retrocompatibilidad

## ğŸ“Š Ejemplo Completo

### Cierre AutomÃ¡tico Programado (DÃ­a con Actividad)

```javascript
{
  uuid: "abc-123-def-456",
  type: "closure",
  description: "Cierre automÃ¡tico programado",
  source: "copilot",
  copilotMode: "scheduled",
  openingReference: "xyz-789",

  initialCashBalance: 500.00,
  initialBankBalance: 300.00,

  totalIngresos: 1200.50,
  totalEgresos: 450.25,
  ingresosCash: 800.00,
  ingresosBank: 400.50,
  egresosCash: 250.00,
  egresosBank: 200.25,

  totalTransferencias: 100.00,
  transferencias: {
    cash: { in: 50.00, out: 100.00, net: -50.00 },
    bank: { in: 100.00, out: 50.00, net: 50.00 }
  },

  ajustesApertura: {
    cash: 20.00,
    bank: -10.00,
    total: 10.00
  },
  ajustesCierre: {
    cash: 0,
    bank: 0,
    total: 0
  },

  expectedCashBalance: 1070.00,
  expectedBankBalance: 540.25,
  realCashBalance: 1070.00,
  realBankBalance: 540.25,

  cashDifference: 0,
  bankDifference: 0,

  resultadoOperacional: 750.25,
  resultadoOperacionalCash: 550.00,
  resultadoOperacionalBank: 200.25,
  flujoNetoCash: 500.00,
  flujoNetoBank: 250.25,

  totalCash: 1070.00,
  totalBank: 540.25,
  cashAmount: 1070.00,
  bankAmount: 540.25,

  items: [],
  itemsAndStockLogs: [],
  amount: 0,

  metadata: {
    day: "2025-10-26",
    triggerType: "scheduled_auto_close",
    autoGenerated: true,
    executionTime: "2025-10-27T00:00:05.123Z",
    hasTransactions: true
  },

  createdAt: Timestamp(2025-10-27T00:00:05.123Z)
}
```

## ğŸ” ValidaciÃ³n de Integridad

Para verificar que una transacciÃ³n de cierre es vÃ¡lida:

```javascript
function validateClosureTransaction(closure) {
  const checks = [
    // Campos requeridos
    closure.uuid !== undefined,
    closure.type === "closure",
    closure.source !== undefined,
    closure.copilotMode !== undefined,

    // Balances
    typeof closure.initialCashBalance === "number",
    typeof closure.realCashBalance === "number",
    typeof closure.expectedCashBalance === "number",

    // Totales
    typeof closure.totalIngresos === "number",
    typeof closure.totalEgresos === "number",

    // Transferencias
    closure.transferencias !== undefined,
    typeof closure.transferencias.cash === "object",
    typeof closure.transferencias.bank === "object",

    // Ajustes
    closure.ajustesApertura !== undefined,
    closure.ajustesCierre !== undefined,

    // Resultados operacionales
    typeof closure.resultadoOperacional === "number",
    typeof closure.flujoNetoCash === "number",

    // Metadata
    closure.metadata !== undefined,
    closure.metadata.triggerType !== undefined,
  ];

  return checks.every((check) => check === true);
}
```

## ğŸš€ Siguientes Pasos

1. **âœ… ImplementaciÃ³n completada** - Estructura unificada en todos los archivos
2. **â³ Testing** - Probar cierres manuales, programados y lazy en desarrollo
3. **â³ MigraciÃ³n** - Actualizar transacciones de cierre existentes si es necesario
4. **â³ DocumentaciÃ³n adicional** - Agregar ejemplos en componentes UI

## ğŸ“ Notas Importantes

- **Retrocompatibilidad:** Los campos legacy (`totalCash`, `totalBank`, `cashAmount`, `bankAmount`) garantizan que cÃ³digo antiguo siga funcionando
- **Campos opcionales seguros:** Uso de optional chaining (`?.`) en backend para acceso seguro
- **Timestamp correcto en lazy-close:** `createdAt` se establece al final del dÃ­a anterior (23:59:59.999)
- **Zero-adjustment en auto-close:** Los cierres automÃ¡ticos siempre tienen `cashDifference: 0` y `bankDifference: 0`

---

**âœ… Implementado por:** GitHub Copilot  
**ğŸ“… Fecha:** 27 de octubre de 2025  
**ğŸ”— Relacionado con:** `ACCOUNTS_BALANCE_STORE_USAGE.md`, `sharedComputed.js`, `getDayAggregates()`
