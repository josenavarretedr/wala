rules_version = '2';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” FIREBASE STORAGE SECURITY RULES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

service firebase.storage {
  match /b/{bucket}/o {

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“ FILE ATTACHMENTS (Temporal Upload)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Path: uploads/tmp/{tenantId}/{uid}/{timestamp-fileId}/original
    // Path: uploads/tmp/{tenantId}/{uid}/{timestamp-fileId}/preview
    match /uploads/tmp/{tenantId}/{uid}/{fileFolder}/{fileName} {
      
      // LECTURA: Solo el dueÃ±o puede leer sus archivos temporales
      allow read: if request.auth != null 
                  && request.auth.uid == uid;
      
      // ESCRITURA: Solo el dueÃ±o puede subir archivos a su carpeta
      allow write: if request.auth != null 
                   && request.auth.uid == uid
                   && validateFileUpload();
      
      // DELETE: Solo el dueÃ±o puede eliminar
      allow delete: if request.auth != null 
                    && request.auth.uid == uid;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“ FILE ATTACHMENTS (Final Location - Futuro)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Path: uploads/{tenantId}/{entityType}/{entityId}/{fileId}/original
    // Path: uploads/{tenantId}/{entityType}/{entityId}/{fileId}/preview
    match /uploads/{tenantId}/{entityType}/{entityId}/{fileId}/{fileName} {
      
      // LECTURA: Usuarios autenticados del mismo tenant
      allow read: if request.auth != null;
                  // TODO: Agregar validaciÃ³n de tenantId cuando se implemente
      
      // ESCRITURA: Solo usuarios autenticados del tenant
      allow write: if request.auth != null
                   && validateFileUpload();
      
      // DELETE: Solo el owner o admin
      allow delete: if request.auth != null;
                    // TODO: Agregar validaciÃ³n de permisos
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸš« DENEGAR TODO LO DEMÃS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”§ FUNCIONES DE VALIDACIÃ“N
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    /**
     * Valida que el archivo cumpla con los requisitos
     */
    function validateFileUpload() {
      return validateFileSize() 
             && validateFileType();
    }

    /**
     * Valida el tamaÃ±o del archivo (mÃ¡x 5MB)
     */
    function validateFileSize() {
      let maxSize = 5 * 1024 * 1024; // 5MB en bytes
      return request.resource.size <= maxSize;
    }

    /**
     * Valida el tipo de archivo (solo imÃ¡genes y PDF)
     */
    function validateFileType() {
      let allowedTypes = [
        'image/jpeg',
        'image/jpg', 
        'image/png',
        'image/heic',
        'image/heif',
        'image/webp',
        'application/pdf'
      ];
      
      return request.resource.contentType in allowedTypes;
    }
  }
}
